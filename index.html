<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>minecarft BE 唱片生成</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            min-height: 100vh;
        }
        
        .glass-panel {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .disc-card {
            background: rgba(15, 23, 42, 0.6);
            border: 2px solid rgba(148, 163, 184, 0.2);
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .disc-card:hover {
            border-color: rgba(59, 130, 246, 0.5);
            transform: translateY(-2px);
        }
        
        .disc-card.selected {
            border-color: #3b82f6;
            background: rgba(59, 130, 246, 0.15);
            box-shadow: 0 0 20px rgba(59, 130, 246, 0.3);
        }
        
        .disc-icon {
            width: 64px;
            height: 64px;
            image-rendering: pixelated;
            background: #1e293b;
            border-radius: 8px;
        }
        
        .input-field {
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid rgba(148, 163, 184, 0.2);
            transition: all 0.3s ease;
        }
        
        .input-field:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            transition: all 0.3s ease;
        }
        
        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px -5px rgba(59, 130, 246, 0.4);
        }
        
        .drop-zone {
            border: 2px dashed rgba(148, 163, 184, 0.3);
            transition: all 0.3s ease;
        }
        
        .drop-zone.dragover {
            border-color: #3b82f6;
            background: rgba(59, 130, 246, 0.1);
        }
        
        .progress-bar {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 9999px;
            overflow: hidden;
        }
        
        .progress-fill {
            background: linear-gradient(90deg, #3b82f6, #8b5cf6);
            transition: width 0.3s ease;
        }
        
        .preview-img {
            image-rendering: pixelated;
            background: #0f172a;
            border: 2px solid rgba(148, 163, 184, 0.3);
        }
    </style>
</head>
<body class="text-slate-200 p-4 md:p-8">
    <div class="max-w-6xl mx-auto">
        <!-- Header -->
        <header class="text-center mb-8">
            <h1 class="text-4xl md:text-5xl font-bold mb-3 bg-gradient-to-r from-blue-400 to-purple-400 bg-clip-text text-transparent">
                minecarft BE 唱片生成
            </h1>
            <p class="text-slate-400 text-lg">
                解释:修改原版唱片的音频 beta26.2.00 测试版有bug欢迎邮箱爆炸,也希望各位大佬来指导指导awa
            </p>
        </header>

        <!-- Main Content -->
        <div class="grid lg:grid-cols-3 gap-6">
            <!-- Left Panel: Disc Selection -->
            <div class="lg:col-span-2 space-y-6">
                <div class="glass-panel rounded-2xl p-6">
                    <h2 class="text-xl font-bold mb-4 flex items-center gap-2">
                        <svg class="w-6 h-6 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3"></path>
                        </svg>
                        选一个你喜欢的唱片
                    </h2>
                    
                    <div class="grid grid-cols-2 md:grid-cols-3 gap-3" id="discGrid">
                        <!-- Generated by JS -->
                    </div>
                </div>

                <!-- Audio Upload -->
                <div class="glass-panel rounded-2xl p-6">
                    <h2 class="text-xl font-bold mb-4 flex items-center gap-2">
                        <svg class="w-6 h-6 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3"></path>
                        </svg>
                        上传你的《美妙》阴乐
                    </h2>
                    
                    <div id="dropZone" class="drop-zone rounded-xl p-8 text-center cursor-pointer relative mb-4">
                        <input type="file" id="audioFile" accept="audio/*,video/mp4,video/webm" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer">
                        <div class="pointer-events-none">
                            <svg class="w-12 h-12 mx-auto mb-3 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                            </svg>
                            <p class="text-slate-300 font-medium">点击或拖拽阴频/逝频文件</p>
                            <p class="text-slate-500 text-sm mt-1">MP3, MP4, WAV, WEBM (最大 20MB)</p>
                        </div>
                    </div>

                    <div id="audioInfo" class="hidden p-4 bg-slate-800/50 rounded-lg">
                        <div class="flex items-center justify-between mb-2">
                            <span class="font-medium text-blue-400" id="audioName">filename.mp3</span>
                            <span class="text-sm text-slate-500" id="audioSize">2.5 MB</span>
                        </div>
                        <div class="flex items-center gap-4 text-sm">
                            <span class="text-slate-400">时长: <span class="text-slate-200" id="audioDuration">3:45</span></span>
                            <span class="text-green-400 flex items-center gap-1">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                </svg>
                                准备就绪
                            </span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Panel: Settings -->
            <div class="space-y-6">
                <div class="glass-panel rounded-2xl p-6">
                    <h2 class="text-xl font-bold mb-4">自定义设置</h2>
                    
                    <!-- Custom Name -->
                    <div class="mb-4">
                        <label class="flex items-center gap-2 mb-2 cursor-pointer">
                            <input type="checkbox" id="enableCustomName" class="w-4 h-4 rounded border-slate-600 text-blue-600 focus:ring-blue-500 bg-slate-700">
                            <span class="text-sm font-medium">自定义唱片名称</span>
                        </label>
                        <input type="text" id="customName" placeholder="输入新名称" class="input-field w-full px-4 py-2 rounded-lg text-white placeholder-slate-500 focus:outline-none disabled:opacity-50" disabled>
                        <p class="text-xs text-slate-500 mt-1">留空则保持原版名称</p>
                    </div>

                    <!-- Custom Texture -->
                    <div class="mb-4">
                        <label class="flex items-center gap-2 mb-2 cursor-pointer">
                            <input type="checkbox" id="enableCustomTexture" class="w-4 h-4 rounded border-slate-600 text-blue-600 focus:ring-blue-500 bg-slate-700">
                            <span class="text-sm font-medium">自定义贴图</span>
                        </label>
                        <div id="textureUpload" class="hidden">
                            <div class="drop-zone rounded-lg p-4 text-center cursor-pointer relative mb-2">
                                <input type="file" id="textureFile" accept="image/png,image/jpeg" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer">
                                <div class="pointer-events-none">
                                    <svg class="w-8 h-8 mx-auto mb-1 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                    </svg>
                                    <p class="text-xs text-slate-400">上传 PNG/JPG (建议 64x64)不是你就别上传了awa</p>
                                </div>
                            </div>
                            <div id="texturePreview" class="hidden flex justify-center">
                                <img id="previewImg" class="preview-img w-16 h-16 rounded" src="" alt="Preview">
                            </div>
                        </div>
                        <p class="text-xs text-slate-500">不勾选则使用原版贴图</p>
                    </div>

                    <!-- Volume -->
                    <div class="mb-6">
                        <label class="block text-sm font-medium mb-2">音量: <span id="volumeValue" class="text-blue-400">1.0</span></label>
                        <input type="range" id="volume" min="0.1" max="1.0" step="0.1" value="1.0" class="w-full h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer accent-blue-500">
                    </div>

                    <!-- Generate Button -->
                    <button id="generateBtn" class="btn-primary w-full py-3 rounded-xl font-bold text-white flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                        <span>生成资源包</span>
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                        </svg>
                    </button>

                    <!-- Progress -->
                    <div id="progressContainer" class="hidden mt-4">
                        <div class="flex justify-between text-sm mb-1">
                            <span class="text-slate-400" id="progressText">准备中...</span>
                            <span class="text-blue-400" id="progressPercent">0%</span>
                        </div>
                        <div class="progress-bar h-2">
                            <div id="progressBar" class="progress-fill h-full w-0"></div>
                        </div>
                    </div>
                </div>

                <!-- Info Panel -->
                <div class="glass-panel rounded-2xl p-6">
                    <h3 class="font-bold mb-3 text-slate-300">使用说明</h3>
                    <ul class="space-y-2 text-sm text-slate-400">
                        <li class="flex items-start gap-2">
                            <span class="text-blue-400">1.</span>
                            <span>选择要覆盖的原版唱片</span>
                        </li>
                        <li class="flex items-start gap-2">
                            <span class="text-blue-400">2.</span>
                            <span>上传你的音乐文件</span>
                        </li>
                        <li class="flex items-start gap-2">
                            <span class="text-blue-400">3.</span>
                            <span>可选：自定义名称和贴图</span>
                        </li>
                        <li class="flex items-start gap-2">
                            <span class="text-blue-400">4.</span>
                            <span>生成并导入资源包</span>
                        </li>
                    </ul>
                    <div class="mt-4 p-3 bg-amber-900/20 border border-amber-700/30 rounded-lg">
                        <p class="text-amber-200 text-xs">
                            覆盖后原唱片将播放你的音乐，可通过唱片机、苦力怕掉落等方式正常获取(其实就是原版唱片改了个内容而已)
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>
 <div class="footer">
    <p>关注steve_tianle！！！</p>
    <p>邮箱 2377039306@qq.com</p>
</div>

    <script>
        // 原版唱片数据
        const VANILLA_DISCS = [
            { id: '13', name: '唱片 13', color: '#1f2937', desc: 'C418 - 13' },
            { id: 'cat', name: '唱片 Cat', color: '#fbbf24', desc: 'C418 - cat' },
            { id: 'blocks', name: '唱片 Blocks', color: '#f59e0b', desc: 'C418 - blocks' },
            { id: 'chirp', name: '唱片 Chirp', color: '#10b981', desc: 'C418 - chirp' },
            { id: 'far', name: '唱片 Far', color: '#3b82f6', desc: 'C418 - far' },
            { id: 'mall', name: '唱片 Mall', color: '#8b5cf6', desc: 'C418 - mall' },
            { id: 'mellohi', name: '唱片 Mellohi', color: '#ec4899', desc: 'C418 - mellohi' },
            { id: 'stal', name: '唱片 Stal', color: '#6b7280', desc: 'C418 - stal' },
            { id: 'strad', name: '唱片 Strad', color: '#a3e635', desc: 'C418 - strad' },
            { id: 'ward', name: '唱片 Ward', color: '#14b8a6', desc: 'C418 - ward' },
            { id: '11', name: '唱片 11', color: '#dc2626', desc: 'C418 - 11' },
            { id: 'wait', name: '唱片 Wait', color: '#06b6d4', desc: 'C418 - wait' }
        ];

        let selectedDisc = null;
        let audioBuffer = null;
        let audioDuration = 0;
        let customTextureData = null;

        // 初始化唱片网格
        function initDiscGrid() {
            const grid = document.getElementById('discGrid');
            VANILLA_DISCS.forEach(disc => {
                const card = document.createElement('div');
                card.className = 'disc-card rounded-xl p-4 flex flex-col items-center gap-2';
                card.dataset.id = disc.id;
                card.innerHTML = `
                    <div class="disc-icon flex items-center justify-center text-2xl font-bold" style="background: ${disc.color}20; color: ${disc.color}; border: 2px solid ${disc.color}40;">
                        ${disc.id.substring(0, 2).toUpperCase()}
                    </div>
                    <div class="text-center">
                        <div class="font-semibold text-sm text-slate-200">${disc.name}</div>
                        <div class="text-xs text-slate-500">${disc.desc}</div>
                    </div>
                `;
                card.addEventListener('click', () => selectDisc(disc, card));
                grid.appendChild(card);
            });
        }

        function selectDisc(disc, cardElement) {
            // 移除其他选中状态
            document.querySelectorAll('.disc-card').forEach(c => c.classList.remove('selected'));
            // 添加选中状态
            cardElement.classList.add('selected');
            selectedDisc = disc;
            checkGenerateReady();
        }

        // 音频处理
        const dropZone = document.getElementById('dropZone');
        const audioFile = document.getElementById('audioFile');

        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('dragover');
        });

        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('dragover');
        });

        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('dragover');
            if (e.dataTransfer.files.length) {
                handleAudioFile(e.dataTransfer.files[0]);
            }
        });

        audioFile.addEventListener('change', (e) => {
            if (e.target.files.length) {
                handleAudioFile(e.target.files[0]);
            }
        });

        async function handleAudioFile(file) {
            if (file.size > 20 * 1024 * 1024) {
                alert('文件太大，请上传小于 20MB 的文件');
                return;
            }

            try {
                const arrayBuffer = await file.arrayBuffer();
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                audioBuffer = await audioContext.decodeAudioData(arrayBuffer);
                audioDuration = Math.floor(audioBuffer.duration);

                // 更新 UI
                document.getElementById('audioName').textContent = file.name;
                document.getElementById('audioSize').textContent = (file.size / 1024 / 1024).toFixed(2) + ' MB';
                
                const mins = Math.floor(audioDuration / 60);
                const secs = audioDuration % 60;
                document.getElementById('audioDuration').textContent = `${mins}:${secs.toString().padStart(2, '0')}`;
                
                document.getElementById('audioInfo').classList.remove('hidden');
                checkGenerateReady();
            } catch (err) {
                alert('无法解析音频文件: ' + err.message);
            }
        }

        // 自定义名称开关
        document.getElementById('enableCustomName').addEventListener('change', (e) => {
            document.getElementById('customName').disabled = !e.target.checked;
            if (e.target.checked) document.getElementById('customName').focus();
        });

        // 自定义贴图开关
        document.getElementById('enableCustomTexture').addEventListener('change', (e) => {
            document.getElementById('textureUpload').classList.toggle('hidden', !e.target.checked);
        });

        // 贴图上传
        document.getElementById('textureFile').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (event) => {
                customTextureData = event.target.result;
                document.getElementById('previewImg').src = customTextureData;
                document.getElementById('texturePreview').classList.remove('hidden');
            };
            reader.readAsDataURL(file);
        });

        // 音量滑块
        document.getElementById('volume').addEventListener('input', (e) => {
            document.getElementById('volumeValue').textContent = e.target.value;
        });

        function checkGenerateReady() {
            const ready = selectedDisc && audioBuffer;
            document.getElementById('generateBtn').disabled = !ready;
        }

        // 音频转 WAV
        function audioBufferToWav(buffer) {
            const numOfChan = buffer.numberOfChannels;
            const length = buffer.length * numOfChan * 2 + 44;
            const arrayBuffer = new ArrayBuffer(length);
            const view = new DataView(arrayBuffer);
            const channels = [];
            let offset = 0;
            let pos = 0;

            // 写入 WAV 头
            setUint32(0x46464952); // RIFF
            setUint32(length - 8); // 文件大小
            setUint32(0x45564157); // WAVE
            setUint32(0x20746d66); // fmt 
            setUint32(16); // 子块大小
            setUint16(1); // 音频格式 (PCM)
            setUint16(numOfChan);
            setUint32(buffer.sampleRate);
            setUint32(buffer.sampleRate * 2 * numOfChan); // 字节率
            setUint16(numOfChan * 2); // 块对齐
            setUint16(16); // 采样位数
            setUint32(0x61746164); // data
            setUint32(length - pos - 4); // 数据大小

            // 写入数据
            for (let i = 0; i < buffer.numberOfChannels; i++) {
                channels.push(buffer.getChannelData(i));
            }

            while (pos < buffer.length) {
                for (let i = 0; i < numOfChan; i++) {
                    let sample = Math.max(-1, Math.min(1, channels[i][pos]));
                    sample = sample < 0 ? sample * 0x8000 : sample * 0x7FFF;
                    view.setInt16(44 + offset, sample, true);
                    offset += 2;
                }
                pos++;
            }

            return new Blob([arrayBuffer], { type: 'audio/wav' });

            function setUint16(data) {
                view.setUint16(pos, data, true);
                pos += 2;
            }
            function setUint32(data) {
                view.setUint32(pos, data, true);
                pos += 4;
            }
        }

        // 生成 UUID
        function generateUUID() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                const r = Math.random() * 16 | 0;
                const v = c == 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }

        // 简单的 PNG 像素数据生成（用于默认图标）
        function createMinimalPNG() {
            // 1x1 像素的透明 PNG
            return new Uint8Array([137, 80, 78, 71, 13, 10, 26, 10, 0, 0, 0, 13, 73, 72, 68, 82, 0, 0, 0, 1, 0, 0, 0, 1, 8, 6, 0, 0, 0, 31, 21, 196, 137, 0, 0, 0, 13, 73, 68, 65, 84, 8, 215, 99, 248, 207, 192, 240, 0, 0, 3, 1, 1, 0, 24, 221, 138, 207, 0, 0, 0, 0, 73, 69, 78, 68, 174, 66, 96, 130]);
        }

        // 生成按钮
        document.getElementById('generateBtn').addEventListener('click', async () => {
            if (!selectedDisc || !audioBuffer) return;

            const useCustomName = document.getElementById('enableCustomName').checked;
            const useCustomTexture = document.getElementById('enableCustomTexture').checked;
            const customNameValue = document.getElementById('customName').value.trim();
            const volume = parseFloat(document.getElementById('volume').value);

            const progressContainer = document.getElementById('progressContainer');
            const progressBar = document.getElementById('progressBar');
            const progressText = document.getElementById('progressText');
            const progressPercent = document.getElementById('progressPercent');

            progressContainer.classList.remove('hidden');
            
            const updateProgress = (percent, text) => {
                progressBar.style.width = percent + '%';
                progressPercent.textContent = percent + '%';
                progressText.textContent = text;
            };

            try {
                updateProgress(10, '转换音频格式...');
                await new Promise(r => setTimeout(r, 100));
                
                const audioBlob = audioBufferToWav(audioBuffer);
                const discId = selectedDisc.id;

                updateProgress(30, '创建资源包结构...');
                const zip = new JSZip();

                // Manifest
                const manifest = {
                    "format_version": 2,
                    "header": {
                        "name": useCustomName && customNameValue ? `${customNameValue} - 覆盖` : `${selectedDisc.name} 覆盖`,
                        "description": `覆盖 ${selectedDisc.name} 音效`,
                        "uuid": generateUUID(),
                        "version": [1, 0, 0],
                        "min_engine_version": [1, 20, 0]
                    },
                    "modules": [
                        {
                            "type": "resources",
                            "uuid": generateUUID(),
                            "version": [1, 0, 0]
                        }
                    ]
                };
                zip.file("manifest.json", JSON.stringify(manifest, null, 4));

                // 覆盖原版唱片音效
                const soundDefs = {
                    "record.13": {
                        "category": "record",
                        "sounds": [{ "name": "sounds/music_disc/13", "stream": true, "volume": 1.0 }]
                    },
                    "record.cat": {
                        "category": "record",
                        "sounds": [{ "name": "sounds/music_disc/cat", "stream": true, "volume": 1.0 }]
                    },
                    "record.blocks": {
                        "category": "record",
                        "sounds": [{ "name": "sounds/music_disc/blocks", "stream": true, "volume": 1.0 }]
                    },
                    "record.chirp": {
                        "category": "record",
                        "sounds": [{ "name": "sounds/music_disc/chirp", "stream": true, "volume": 1.0 }]
                    },
                    "record.far": {
                        "category": "record",
                        "sounds": [{ "name": "sounds/music_disc/far", "stream": true, "volume": 1.0 }]
                    },
                    "record.mall": {
                        "category": "record",
                        "sounds": [{ "name": "sounds/music_disc/mall", "stream": true, "volume": 1.0 }]
                    },
                    "record.mellohi": {
                        "category": "record",
                        "sounds": [{ "name": "sounds/music_disc/mellohi", "stream": true, "volume": 1.0 }]
                    },
                    "record.stal": {
                        "category": "record",
                        "sounds": [{ "name": "sounds/music_disc/stal", "stream": true, "volume": 1.0 }]
                    },
                    "record.strad": {
                        "category": "record",
                        "sounds": [{ "name": "sounds/music_disc/strad", "stream": true, "volume": 1.0 }]
                    },
                    "record.ward": {
                        "category": "record",
                        "sounds": [{ "name": "sounds/music_disc/ward", "stream": true, "volume": 1.0 }]
                    },
                    "record.11": {
                        "category": "record",
                        "sounds": [{ "name": "sounds/music_disc/11", "stream": true, "volume": 1.0 }]
                    },
                    "record.wait": {
                        "category": "record",
                        "sounds": [{ "name": "sounds/music_disc/wait", "stream": true, "volume": 1.0 }]
                    }
                };

                // 替换选中的唱片音效
                const targetKey = discId === '11' || discId === '13' ? `record.${discId}` : `record.${discId}`;
                if (soundDefs[targetKey]) {
                    soundDefs[targetKey].sounds[0].volume = volume;
                }

                zip.file("sounds/sound_definitions.json", JSON.stringify(soundDefs, null, 4));

                // 放入音频文件
                updateProgress(50, '打包音频文件...');
                
                // 将所有唱片音效都指向同一个文件（覆盖逻辑）
                // 或者只覆盖选中的那个
                const soundPath = `sounds/music_disc/${discId}`;
                
                // 由于我们是在覆盖，我们需要替换指定路径的音效
                // 但为了让游戏能识别，我们需要保持文件名与原版一致
                zip.file(`${soundPath}.wav`, audioBlob);

                // 贴图处理
                updateProgress(70, '处理贴图...');
                if (useCustomTexture && customTextureData) {
                    // 将 base64 转换为 blob
                    const response = await fetch(customTextureData);
                    const textureBlob = await response.blob();
                    
                    // 贴图路径：覆盖 items/music_disc_${discId}
                    // 注意：基岩版贴图命名
                    const textureName = discId === '11' || discId === '13' ? `disc_${discId}` : `disc_${discId}`;
                    zip.file(`textures/items/${textureName}.png`, textureBlob);
                    
                    // 创建 item_texture.json 覆盖定义
                    const itemTexture = {
                        "texture_data": {
                            [textureName]: {
                                "textures": `textures/items/${textureName}`
                            }
                        }
                    };
                    zip.file("textures/item_texture.json", JSON.stringify(itemTexture, null, 4));
                }

                // 语言文件（自定义名称）
                if (useCustomName && customNameValue) {
                    const langKey = discId === '11' || discId === '13' ? 
                        `item.record.${discId}.desc` : 
                        `item.record.${discId}.desc`;
                    
                    // 基岩版唱片名称键
                    const langContent = `${langKey}=${customNameValue}`;
                    zip.file("texts/en_US.lang", langContent);
                    zip.file("texts/zh_CN.lang", langContent);
                    zip.file("texts/languages.json", JSON.stringify(["en_US", "zh_CN"], null, 4));
                }

                // Pack 图标
                zip.file("pack_icon.png", createMinimalPNG());

                updateProgress(91(恭喜你发现了作者的彩蛋), '生成压缩包...');
                const content = await zip.generateAsync({type: "blob"});

                updateProgress(100, '完成！');
                
                // 下载
                const fileName = useCustomName && customNameValue ? 
                    `${customNameValue.replace(/\s+/g, '_')}_Resource.mcpack` : 
                    `${discId}_Override_Resource.mcpack`;
                
                const url = URL.createObjectURL(content);
                const a = document.createElement('a');
                a.href = url;
                a.download = fileName;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                setTimeout(() => {
                    progressContainer.classList.add('hidden');
                }, 2000);

            } catch (err) {
                console.error(err);
                alert('生成失败那你就受着: ' + err.message);
                progressContainer.classList.add('hidden');
            }
        });

        // 初始化
        initDiscGrid();
    </script>
</body>
</html>
